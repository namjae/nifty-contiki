<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Tutorial 2: Compiling and Linking &#8211; Nifty - NIF Interface Generator</title>
<meta name="description" content="">
<meta name="keywords" content="tutorial">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Tutorial 2: Compiling and Linking">
<meta property="og:description" content="New, Documentation and Tutorials of Nifty">
<meta property="og:url" content="http://parapluu.github.io/nifty//tutorial2/">
<meta property="og:site_name" content="Nifty - NIF Interface Generator">





<link rel="canonical" href="http://parapluu.github.io/nifty//tutorial2/">
<link href="http://parapluu.github.io/nifty//feed.xml" type="application/atom+xml" rel="alternate" title="Nifty - NIF Interface Generator Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="http://parapluu.github.io/nifty//assets/css/main.min.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://parapluu.github.io/nifty//assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://parapluu.github.io/nifty//assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://parapluu.github.io/nifty//assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://parapluu.github.io/nifty//favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://parapluu.github.io/nifty//favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://parapluu.github.io/nifty//images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://parapluu.github.io/nifty//images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://parapluu.github.io/nifty//images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://parapluu.github.io/nifty//images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="page">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://parapluu.github.io/nifty/">Nifty - NIF Interface Generator</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				<li><a href="http://parapluu.github.io/nifty//about" >About</a></li>
		        
				<li><a href="http://parapluu.github.io/nifty//api-doc/index.html" >API Documentation</a></li>
		        
				<li><a href="http://parapluu.github.io/nifty//install" >Install Nifty</a></li>
		        
				<li><a href="http://parapluu.github.io/nifty//tutorial" >Tutorials</a></li>
		        
				<li><a href="https://github.com/parapluu/nifty" target="_blank">GitHub</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->


  <div class="image-wrap">
  <img src=
    
      "http://parapluu.github.io/nifty//images/nifty_trouble.png"
    
  alt="Tutorial 2: Compiling and Linking feature image">
  
  </div><!-- /.image-wrap -->


<div id="main" role="main">
  <div class="article-author-side">
    
	<img src="http://parapluu.github.io/nifty//images/avatar.png" class="bio-photo" alt="Nifty bio photo"></a>

<h3>Nifty</h3>
<p>Nifty - NIF interface generator</p>






<a href="http://github.com/parapluu/nifty" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>






  </div>
  <article>
    <h1>Tutorial 2: Compiling and Linking</h1>
    <div class="article-wrap">
      <p><a  href="http://parapluu.github.io/nifty//files/tut2.tar.gz"><strong>Files For This Tutorial</strong></a></p>

<h2 id="toc_0">Compile and Link Flags</h2>

<p>In the <a href="http://parapluu.github.io/nifty//tutorial1">previous tutorial</a> we saw how we can
create simple NIF modules and compile them together with some C code. In reality
the process of compiling is not that simple. We might need to specify additional
paths for included files or link against a library. This tutorial shows how you
can set arbitrary compile options. </p>

<h2 id="toc_1">Setup</h2>

<p>In this example we want to build a NIF module from the C library answer. The sources
of the library look like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">.
├── include
│   ├── answer.h
│   └── types.h
├── libanswer.a
├── Makefile
└── src
    └── ...
</code></pre></div>
<p>We have two header files in <code>include/</code>, a <code>Makefile</code> and a static library that was built 
by invoking make. There are also a couple of C files in <code>src</code>.</p>

<h2 id="toc_2">Setting Compiler Parameters</h2>

<p>The header file <code>answer.h</code> defines one function:</p>

<div class="highlight"><pre><code class="c++"><span class="cp">#include &quot;types.h&quot;</span>

<span class="k">extern</span> <span class="kt">my_t</span> <span class="nf">life_universe_and_everything</span><span class="p">();</span>
</code></pre></div>

<p><code>types.h</code> contains the type <code>my_t</code> which <code>life_universe_and_everything()</code> uses as return type:</p>

<div class="highlight"><pre><code class="c++"><span class="k">typedef</span> <span class="kt">short</span> <span class="kt">my_t</span><span class="p">;</span>
</code></pre></div>

<p>Nifty will scan all include files, but we have to tell it where to find them.
We also need to pass the same information to the C compiler when we compile the NIF module.
Typically we pass this information as parts of <code>CFLAGS</code> environment variable. The build system
takes care of the rest:</p>

<div class="highlight"><pre><code class="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">nifty</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="s">&quot;include/answer.h&quot;</span><span class="p">,</span> 
                 <span class="n">answer</span><span class="p">,</span>
                 <span class="p">[{</span><span class="n">port_specs</span><span class="p">,[{</span><span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="s">&quot;$NIF&quot;</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[{</span><span class="n">env</span><span class="p">,[{</span><span class="s">&quot;CFLAGS&quot;</span><span class="p">,</span><span class="s">&quot;$CFLAGS -Iinclude/&quot;</span><span class="p">}]}]}]}]).</span>
</code></pre></div>

<p>We can add aditional compile options for our $NIF target. We set <code>CFLAGS</code> to the old <code>CFLAGS</code> plus
flag the compile needs to create the module.</p>

<p>In a similar way we can add options to the linker using <code>LDFLAGS</code> instead of <code>CFLAGS</code> to tell Nifty
that it should include <code>libanswer.a</code> when linking everything:</p>

<div class="highlight"><pre><code class="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">nifty</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="s">&quot;include/answer.h&quot;</span><span class="p">,</span> 
                 <span class="n">answer</span><span class="p">,</span>
                 <span class="p">[{</span><span class="n">port_specs</span><span class="p">,[{</span><span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="s">&quot;$NIF&quot;</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[{</span><span class="n">env</span><span class="p">,[{</span><span class="s">&quot;CFLAGS&quot;</span><span class="p">,</span><span class="s">&quot;$CFLAGS -Iinclude/&quot;</span><span class="p">},</span>
                                      <span class="p">{</span><span class="s">&quot;LDFLAGS&quot;</span><span class="p">,</span> <span class="s">&quot;$LDFLAGS $NIFTY_ROOT/libanswer.a&quot;</span><span class="p">}]}]}]}]).</span>
</code></pre></div>

<p>In order for Nifty to find <code>libanswer.a</code> we have to specify the correct path. Nifty does not create 
the NIF module directly in the currend working directory, but a complete package:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">answer/
├── c_src
│   └── answer_nif.c
├── ebin
│   └── answer.app
├── include
│   └── answer.hrl
├── priv
├── rebar.config
└── src
    ├── answer_remote.erl
    └── answer.erl
</code></pre></div>
<p>When compiling the module Nifty changes to <code>answer/</code> and calls <code>rebar compile</code>. <code>rebar</code> now needs to find
all files from this directory. This means, that we either have to use absolute paths or relative paths starting
from <code>answer/</code>. Thanksfully Nifty provides the envrionment variable <code>NIFTY_ROOT</code> that points to the directory which you are
currently in, when you call <code>nifty:compile/3</code>. </p>

<h2 id="toc_3">Compile Hooks</h2>

<p>In our example the library already has a build system
and the build process itself is probably not straight forward. Instead of
reinventing the wheel and reimplementing the build process, you should use compile hooks.
compile hooks are actions that are executed before or after compilation. In this example we
want to invoke <code>make</code> before compilation:</p>

<div class="highlight"><pre><code class="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">nifty</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="s">&quot;include/answer.h&quot;</span><span class="p">,</span> 
                 <span class="n">answer</span><span class="p">,</span>
                 <span class="p">[{</span><span class="n">port_specs</span><span class="p">,[{</span><span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="s">&quot;$NIF&quot;</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[{</span><span class="n">env</span><span class="p">,[{</span><span class="s">&quot;CFLAGS&quot;</span><span class="p">,</span><span class="s">&quot;$CFLAGS -Iinclude/&quot;</span><span class="p">},</span>
                                      <span class="p">{</span><span class="s">&quot;LDFLAGS&quot;</span><span class="p">,</span> <span class="s">&quot;$LDFLAGS $NIFTY_ROOT/libanswer.a&quot;</span><span class="p">}]}]}]},</span>
                  <span class="p">{</span><span class="n">pre_hooks</span><span class="p">,</span> <span class="p">[{</span><span class="n">compile</span><span class="p">,</span> <span class="s">&quot;sh -c </span><span class="se">\&quot;</span><span class="s">make</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">}]}]).</span>
</code></pre></div>

<p>This will result in an error, indicating that the makefile was not found:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">make: *** No targets specified and no makefile found.  Stop.
ERROR: Command [compile] failed!
{error,compile}
</code></pre></div>
<p>We have to again adjust the path for make:</p>

<div class="highlight"><pre><code class="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">nifty</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="s">&quot;include/answer.h&quot;</span><span class="p">,</span> 
                 <span class="n">answer</span><span class="p">,</span>
                 <span class="p">[{</span><span class="n">port_specs</span><span class="p">,[{</span><span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="s">&quot;$NIF&quot;</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[{</span><span class="n">env</span><span class="p">,[{</span><span class="s">&quot;CFLAGS&quot;</span><span class="p">,</span><span class="s">&quot;$CFLAGS -Iinclude/&quot;</span><span class="p">},</span>
                                      <span class="p">{</span><span class="s">&quot;LDFLAGS&quot;</span><span class="p">,</span> <span class="s">&quot;$LDFLAGS $NIFTY_ROOT/libanswer.a&quot;</span><span class="p">}]}]}]},</span>
                  <span class="p">{</span><span class="n">pre_hooks</span><span class="p">,</span> <span class="p">[{</span><span class="n">compile</span><span class="p">,</span> <span class="s">&quot;sh -c </span><span class="se">\&quot;</span><span class="s">cd $NIFTY_ROOT &amp;&amp; make</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">}]}]).</span>
</code></pre></div>

<p>In a similar way we can call <code>make clean</code> after we have built our NIF:</p>

<div class="highlight"><pre><code class="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">nifty</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="s">&quot;include/answer.h&quot;</span><span class="p">,</span> 
                 <span class="n">answer</span><span class="p">,</span>
                 <span class="p">[{</span><span class="n">port_specs</span><span class="p">,[{</span><span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="s">&quot;$NIF&quot;</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[{</span><span class="n">env</span><span class="p">,[{</span><span class="s">&quot;CFLAGS&quot;</span><span class="p">,</span><span class="s">&quot;$CFLAGS -Iinclude/&quot;</span><span class="p">},</span>
                                      <span class="p">{</span><span class="s">&quot;LDFLAGS&quot;</span><span class="p">,</span> <span class="s">&quot;$LDFLAGS $NIFTY_ROOT/libanswer.a&quot;</span><span class="p">}]}]}]},</span>
                  <span class="p">{</span><span class="n">pre_hooks</span><span class="p">,</span> <span class="p">[{</span><span class="n">compile</span><span class="p">,</span> <span class="s">&quot;sh -c </span><span class="se">\&quot;</span><span class="s">cd $NIFTY_ROOT &amp;&amp; make</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">}]},</span>
                  <span class="p">{</span><span class="n">post_hooks</span><span class="p">,</span> <span class="p">[{</span><span class="n">compile</span><span class="p">,</span> <span class="s">&quot;sh -c </span><span class="se">\&quot;</span><span class="s">cd $NIFTY_ROOT &amp;&amp; make clean</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">}]}]).</span>
</code></pre></div>

<table><thead>
<tr>
<th><a  href="http://parapluu.github.io/nifty//tutorial1">Previous Tutorial</a></th>
<th><a  href="http://parapluu.github.io/nifty//files/tut2.tar.gz">Tutorial Files</a></th>
<th><a  href="http://parapluu.github.io/nifty//tutorial3">Next Tutorial</a></th>
</tr>
</thead><tbody>
</tbody></table>

    </div><!-- /.article-wrap -->
    
  </article>
</div><!-- /#index -->

<div class="footer-wrap">
  <footer>
    <span>&copy; 2014 Nifty. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://parapluu.github.io/nifty//assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://parapluu.github.io/nifty//assets/js/scripts.min.js"></script>

          

</body>
</html>